<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Noughts and Crosses</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f2f2f2;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 10px;
      justify-content: center;
      margin-top: 40px;
    }
    .cell {
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 10px;
      font-size: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #info {
      margin-top: 10px;
      font-size: 14px;
    }
    a.back {
      position: absolute;
      left: 10px;
      top: 10px;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <a href="../index.html" class="back">← Back</a>
  <h1>Noughts and Crosses</h1>
  <p id="status">Loading...</p>
  <div id="info"></div>
  <div id="board"></div>
  <div id="gameOverMenu" style="display:none; margin-top:20px;">
    <button onclick="playAgain()">Play Again</button>
    <button onclick="changeDifficulty()">Change Difficulty</button>
    <button onclick="goHome()">Home</button>
  </div>

  <!-- Shared scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
  <script src="../scripts/firebase-config.js"></script>
  <script src="../scripts/ai.js"></script>
  
  <script src="../scripts/online.js"></script>

  <script>
    // Parse query params
    // Parse query params
    const params = new URLSearchParams(window.location.search);
    
    const start = params.get("start"); // "player" or "computer"
    const mode = params.get("mode") || "local";
    const difficulty = params.get("difficulty") || "medium";

    let playerTurn = (start === "player");

    const boardArr = ["", "", "", "", "", "", "", "", ""];
    const boardDiv = document.getElementById("board");
    const status = document.getElementById("status");
    const info = document.getElementById("info");
    // Hide "Change Difficulty" button in PvP or Online
    if (mode !== "ai") {
      const diffBtn = document.querySelector('button[onclick="changeDifficulty()"]');
      if (diffBtn) diffBtn.style.display = "none";
    }

    // For online mode
    const GAME_NAME = "noughts";
    let roomId = null;
    let mySymbol = "X";
    let currentTurn = "X";
    let isMyTurn = true;
    
    

    // Create board UI
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.index = i;
    
      if (mode === "ai") {
        cell.addEventListener("click", () => handleAIClick(i));
      } else if (mode === "local") {
        cell.addEventListener("click", () => handleLocalClick(i));
      } else if (mode === "online") {
        cell.addEventListener("click", () => handleOnlineClick(i));
      }
    
      boardDiv.appendChild(cell);
    }

    if (mode === "local") {
      initLocal();
    } else if (mode === "ai") {
      initVsAI();
    
      // ✅ Only trigger AI AFTER initVsAI has finished
      if (start === "computer") {
        status.textContent = "Computer starts!";
        aiTurn();
      } else {
        status.textContent = "Your turn!";
      }
    
    } else if (mode === "online") {
      initOnline();
    } else {
      status.textContent = "Unknown mode.";
    }

    function initLocal() {
      status.textContent = "Local PvP: X to move";
      info.textContent = "";
    }

    function initVsAI() {
      status.textContent = "Vs Computer (" + difficulty + "): Your turn (X)";
      info.textContent = "Computer is O";
    }

    async function initOnline() {
      // If no roomId in URL, create one and show it
      const urlRoom = params.get("room");
      if (!urlRoom) {
        roomId = createRoom(GAME_NAME);
        mySymbol = "X";
        currentTurn = "X";
        isMyTurn = true;
        status.textContent = "Online PvP: You are X. Share this room ID:";
        info.textContent = "Room ID: " + roomId + "\nAdd ?room=" + roomId + " to the URL for Player 2.";
      } else {
        roomId = urlRoom;
        const snap = await joinRoom(GAME_NAME, roomId);
        if (!snap.exists()) {
          status.textContent = "Room not found.";
          return;
        }
        mySymbol = "O";
        currentTurn = "X";
        isMyTurn = false;
        status.textContent = "Online PvP: You are O. Waiting for X...";
        info.textContent = "Room ID: " + roomId;
      }

      // Listen for moves
      onMove(GAME_NAME, roomId, move => {
        const idx = move.index;
        const symbol = move.symbol;
        if (boardArr[idx] === "") {
          boardArr[idx] = symbol;
          render();
          if (checkWin(symbol)) {
            status.textContent = symbol + " wins!";
            disableBoard();
            showGameOverMenu();
            return;
          }
          if (boardArr.every(c => c !== "")) {
            status.textContent = "Draw!";
            disableBoard();
            showGameOverMenu();
            return;
          }
          currentTurn = (symbol === "X") ? "O" : "X";
          isMyTurn = (currentTurn === mySymbol);
          status.textContent = "Online: " + currentTurn + " to move" + (isMyTurn ? " (your turn)" : "");
        }
      });
    }

    function handleAIClick(i) {
      if (!playerTurn) return;
      if (boardArr[i] !== "") return;
    
      // ✅ Update board state FIRST
      boardArr[i] = "X";
      render();
    
      // ✅ Check if player won
      if (checkWin("X")) {
        status.textContent = "You win!";
        disableBoard();
        showGameOverMenu();
        return;
      }
    
      // ✅ Check draw
      if (boardArr.every(c => c !== "")) {
        status.textContent = "Draw!";
        disableBoard();
        showGameOverMenu();
        return;
      }
    
      // ✅ Lock input BEFORE AI moves
      playerTurn = false;
      status.textContent = "Computer thinking...";
    
      // ✅ AI now sees the correct board state
      setTimeout(aiTurn, 400);
    }

    // Local PvP
    function handleLocalClick(i) {
      // ✅ Prevent clicking filled squares
      if (boardArr[i] !== "") return;
    
      // ✅ Place symbol
      boardArr[i] = currentTurn;
      updateBoard();
    
      // ✅ Check win
      if (checkWin(currentTurn)) {
        status.textContent = currentTurn + " wins!";
        disableBoard();
        showGameOverMenu();
        return;
      }
    
      // ✅ Check draw
      if (boardArr.every(c => c !== "")) {
        status.textContent = "Draw!";
        disableBoard();
        showGameOverMenu();
        return;
      }
    
      // ✅ Switch turn
      currentTurn = currentTurn === "X" ? "O" : "X";
      status.textContent = currentTurn + "'s turn";
    }
    // Vs AI
    function handleAIClick(i) {
      if (!playerTurn) return;      // ✅ prevents double moves
      if (boardArr[i] !== "") return;
    
      boardArr[i] = "X";
      render();
    
      if (checkWin("X")) {
        status.textContent = "You win!";
        disableBoard();
        showGameOverMenu();
        return;
      }
    
      if (boardArr.every(c => c !== "")) {
        status.textContent = "Draw!";
        disableBoard();
        showGameOverMenu();
        return;
      }
    
      playerTurn = false;           // ✅ lock player input
      status.textContent = "Computer thinking...";
    
      setTimeout(aiTurn, 400);
    }
    function findWinningMove(symbol) {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
    
      for (const combo of wins) {
        const [a, b, c] = combo;
        const line = [boardArr[a], boardArr[b], boardArr[c]];
    
        // If two are the symbol and one is empty → winning/blocking move
        if (line.filter(v => v === symbol).length === 2 &&
            line.filter(v => v === "").length === 1) {
          return combo[line.indexOf("")];
        }
      }
      return null;
    }
    function findForkMove(symbol) {
      const empty = boardArr
        .map((v, i) => v === "" ? i : null)
        .filter(v => v !== null);
    
      for (const move of empty) {
        // Try placing symbol temporarily
        boardArr[move] = symbol;
    
        let winningMoves = 0;
        const wins = [
          [0,1,2],[3,4,5],[6,7,8],
          [0,3,6],[1,4,7],[2,5,8],
          [0,4,8],[2,4,6]
        ];
    
        for (const combo of wins) {
          const [a, b, c] = combo;
          const line = [boardArr[a], boardArr[b], boardArr[c]];
          if (line.filter(v => v === symbol).length === 2 &&
              line.filter(v => v === "").length === 1) {
            winningMoves++;
          }
        }
    
        // Undo move
        boardArr[move] = "";
    
        if (winningMoves >= 2) return move;
      }
    
      return null;
    }
    function easyMove() {
      const empty = boardArr
        .map((v, i) => v === "" ? i : null)
        .filter(v => v !== null);
    
      return empty[Math.floor(Math.random() * empty.length)];
    }
    function mediumMove() {
      // 1. Block player win
      const block = findWinningMove("X");
      if (block !== null) return block;
    
      // 2. Otherwise random
      return easyMove();
    }
    function hardMove() {
      // 1. Win if possible
      const win = findWinningMove("O");
      if (win !== null) return win;
    
      // 2. Block player win
      const block = findWinningMove("X");
      if (block !== null) return block;
    
      // 3. Create a fork
      const fork = findForkMove("O");
      if (fork !== null) return fork;
    
      // 4. Block player's fork
      const blockFork = findForkMove("X");
      if (blockFork !== null) return blockFork;
    
      // 5. Take centre
      if (boardArr[4] === "") return 4;
    
      // 6. Take a corner
      const corners = [0, 2, 6, 8].filter(i => boardArr[i] === "");
      if (corners.length > 0) return corners[Math.floor(Math.random() * corners.length)];
    
      // 7. Otherwise random
      return easyMove();
    }

    function aiTurn() {
      let moveIndex;
    
      if (difficulty === "easy") {
        moveIndex = easyMove();
      } else if (difficulty === "medium") {
        moveIndex = mediumMove();
      } else {
        moveIndex = hardMove();
      }
    
      boardArr[moveIndex] = "O";
      render();
    
      if (checkWin("O")) {
        status.textContent = "Computer wins!";
        disableBoard();
        showGameOverMenu();
        return;
      }

      if (boardArr.every(c => c !== "")) {
        status.textContent = "Draw!";
        disableBoard();
        showGameOverMenu();
        return;
      }
    
      playerTurn = true;
      status.textContent = "Your turn!";
      console.log("AI chose:", moveIndex, "Board:", boardArr);
    }
    // Online
    function handleOnlineClick(i) {
      if (!isMyTurn) return;
      if (!roomId) return;
      if (boardArr[i] !== "") return;

      boardArr[i] = mySymbol;
      render();
      sendMove(GAME_NAME, roomId, { index: i, symbol: mySymbol });

      if (checkWin(mySymbol)) {
        status.textContent = mySymbol + " wins!";
        disableBoard();
        showGameOverMenu();
        return;
      }
      if (boardArr.every(c => c !== "")) {
        status.textContent = "Draw!";
        disableBoard();
        showGameOverMenu();
        return;
      }

      currentTurn = (mySymbol === "X") ? "O" : "X";
      isMyTurn = false;
      status.textContent = "Online: " + currentTurn + " to move (waiting...)";
    }

    function render() {
      document.querySelectorAll(".cell").forEach(cell => {
        const i = cell.dataset.index;
        cell.textContent = boardArr[i];
      });
    }

    function checkWin(symbol) {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      return wins.some(combo =>
        combo.every(i => boardArr[i] === symbol)
      );
    }

    function disableBoard() {
      document.querySelectorAll(".cell").forEach(c => {
        c.style.pointerEvents = "none";
      });
    }
    function showGameOverMenu() {
      document.getElementById("gameOverMenu").style.display = "block";
    }
    
    function playAgain() {
      location.reload();
    }
    
    function changeDifficulty() {
      location.href = "../difficulty.html";
    }
    
    function goHome() {
      location.href = "../index.html";
    }

    // Initial render
    render();
  </script>
</body>
</html>
